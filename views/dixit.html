<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Dixit</title>
    </head>
 
    <body>
        <style>
            body{
                font-family: sans-serif;
                background: #0B3861;
                color:white;
                text-align: center;
            }
            input{
                padding:5px;
                border-radius:5px;
            }
            input[type=submit]{
                background-color:#210B61;
                color:white;
                border-color:#240B3B;
            }
            ul#online-players{
                font-weight: bold;
                list-style: none;
                padding:0;
            }
            ul#online-players span{
                color:yellow;
            }
            div.vue{
                display:none;
            }
            div.current-view{
                display:block;
            }
            div.chef{
                display:none;
            }
            div.current-chef{
                display:block;
            }
            td{
                width:30%;
                height: 50%;
            }
            img.carte{                        
                width:90%;
                height:auto;
                border: 5px hidden green;
            }
            img.carte-choisie, img.carte-choisie-d{
                border:5px solid green;
                border-radius: 20px;
                box-shadow: 0px 0px 25px 5px green;
            }
        </style>

        <div id="message-server"></div>

        <!-- VUE A : choix du pseudo -->
        <div id="vue-A" class="current-view vue">
            <h1>Bienvenue sur le jeu Dixit !</h1>

            <h2>Choisis ton pseudo</h2>
            <p>
                <input type="text" id="pseudo-input" name="pseudo" placeholder="Pseudo">
                <input type="submit" value="Valider" onclick="sendPseudo()"/>
            </p> 
        </div>



        <!-- VUE B : salle d'attente -->
        <div id="vue-B" class="vue">
            <h1 id="pseudo"></h1>
            <h2>Attendons que tout le monde soit pr√™t...</h2>
            
            <div class="chef">Tu es le chef du groupe, c'est √† toi de d√©cider quand commencer (attends que tout le monde soit l√†...)</div>
            </br>

            <div id="players"> En ligne : 
                <ul id="online-players"></ul>
            </div>

            <div class="chef">
                <input type="submit" value="Commencer" onclick="socket.emit('start_game');"/>
            </div>
        </div>



        <!-- VUE C : voir ses cartes -->
        <div id="vue-C" class="vue">
            <h1 class="counter"></h1>

            <h1 id="inst-with-keyphrase" class="hide-if-counter" style="display:none">Choisis ta carte qui se rapporte le mieux √† : "<span class="phrase-clef"></span>"</h1>

            <div id="phrase-clef-input" class="hide-if-not-counter">
                <input type="text" id="phrase-clef-input-text" name="phrase-clef" placeholder="Ta phrase">
                <input type="submit" value="Valider" onclick="sendKeyPhrase()"/>
            </div>

            <input id="choose-card-to-play" style="display:none" class="hide-if-counter" type="submit" value="Valider" onclick="cardToPlayChosen()"/>

            <div class="cards-container">
                <table>
                    <tbody>
                        <tr>
                            <td><img id="carte0" class="carte" onclick="cardSelected(this.id)"></td>
                            <td><img id="carte1" class="carte" onclick="cardSelected(this.id)"></td>
                            <td><img id="carte2" class="carte" onclick="cardSelected(this.id)"></td>
                        </tr>
                        <tr>
                            <td><img id="carte3" class="carte" onclick="cardSelected(this.id)"></td>
                            <td><img id="carte4" class="carte" onclick="cardSelected(this.id)"></td>
                            <td><img id="carte5" class="carte" onclick="cardSelected(this.id)"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>



        <!-- VUE D : voir les cartes sur le plateau -->
        <div id="vue-D" class="vue">
            <div class="hide-if-counter">
                <h1>Passons aux votes !</h1>
                <h1>Selon toi, quelle carte correspond √† "<span class="phrase-clef"></span>" ?</h1>
                <input type="submit" value="Voter" onclick="sendVote()"/>
            </div>
            <h1><span class="hide-if-not-counter">Les autres joueurs sont en train de voter !</span></h1>

            <div class="cards-container">
                <table>
                    <tbody id="plateau">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VUE E : scores -->
        <div id="vue-E" class="vue">
            <h1>Voici les scores</h1>
            
            <div class="scores">
                
            </div>
        </div>

        



        <script src="/socket.io/socket.io.js"></script>
        <script>
            let socket = io.connect(document.location.href);
            let pseudo;
            let counter=false;

            function sendPseudo() {
                pseudo = document.getElementById("pseudo-input").value;
                socket.emit('pseudo', pseudo);
                document.getElementById("pseudo").innerHTML = "Bienvenue " + pseudo + " !";
            }


            socket.on('change_view', function(view) {
                document.getElementById("message-server").innerHTML = "";
                document.getElementsByClassName("current-view")[0].classList.remove("current-view");
                document.getElementById("vue-"+view).classList.add("current-view");
                if(view==='C'){
                    socket.emit('tirage');
                }

            })

            // Liste des joueurs
            socket.on('players_list', function(list) {
                let ul = document.getElementById("online-players");
                
                while (ul.hasChildNodes()) {  
                    ul.removeChild(ul.firstChild);
                }

                for (let i=0; i<list.length ; i++) {
                    let li = document.createElement("li");
                    li.appendChild(document.createTextNode(list[i]));
                    if(i==0){ // ic√¥ne de chef
                        let span = document.createElement("span");
                        span.innerHTML = "üëë";
                        li.appendChild(span);
                    }
                    ul.appendChild(li);
                }
            });
            /*
            socket.on('leader', function() {
                for(let i=0; i<document.getElementsByClassName("chef").length; i++) {
                    document.getElementsByClassName("chef")[i].classList.add("current-chef");
                }
            }); */

            socket.on('new_leader', function(pseudo_chef) {
                if(pseudo_chef==pseudo) {
                    socket.emit('log-message', "Je suis le nouveau chef : " + pseudo);
                    for(let i=0; i<document.getElementsByClassName("chef").length; i++) {
                        document.getElementsByClassName("chef")[i].classList.add("current-chef");
                    }
                } else {
                    for(let i=0; i<document.getElementsByClassName("chef").length; i++) {
                        document.getElementsByClassName("chef")[i].classList.remove("current-chef");
                    }
                }
            });

            // Message d'erreur
            socket.on('message', function(message) {
                document.getElementById("message-server").innerHTML = message;
                /*setTimeout(function() {
                    document.getElementById("message-server").innerHTML = ''; 
                }, 1000);*/
                
            })

            socket.on('tirage', function(cartes){
                for (var i = 0; i < cartes.length; i++) {
                    document.getElementById("carte"+i).src = cartes[i];
                }
            });

            socket.on('counter', function(pseudo_counter) {
                let c = document.getElementsByClassName("counter")[0];
                let list_name;
                if(pseudo==pseudo_counter) {
                    counter=true;
                    c.innerHTML = "Tu es le conteur, choisis une carte et ta phrase.";
                    list_name = "hide-if-counter"; 
                } else {
                    list_name = "hide-if-not-counter"; 
                    counter=false;
                    c.innerHTML = "Le conteur est : " + pseudo_counter + ". Attends qu'il ait choisi sa carte."
                }
                while(document.getElementsByClassName(list_name).length > 0){
                    let to_remove = document.getElementsByClassName(list_name)[0];
                    to_remove.parentNode.removeChild(to_remove);
                }
            });

            


            function sendKeyPhrase(){
                if(document.getElementsByClassName("carte-choisie").length==0){
                    document.getElementById("message-server").innerHTML = "N'oublie pas de s√©lectionner une carte d'abord !";
                } else {
                    let carte = document.getElementsByClassName("carte-choisie")[0];
                    let src = carte.src;
                    key_phrase = document.getElementById("phrase-clef-input-text").value;
                    socket.emit('counter_choice', src, key_phrase);
                }
            }

            socket.on('reveal_counter_choice', function(card, key_phrase) {
                for(let i=0; i<document.getElementsByClassName("phrase-clef").length; i++) {
                    document.getElementsByClassName("phrase-clef")[i].innerHTML = key_phrase;
                }
                if(counter) {
                    let to_remove = document.getElementById("phrase-clef-input");
                    to_remove.parentNode.removeChild(to_remove);
                    document.getElementsByClassName("counter")[0].innerHTML="Tes camarades sont en train de choisir leurs cartes.";
                } else {
                    let to_display = document.getElementById("inst-with-keyphrase");
                    to_display.style="";
                    let to_display_b = document.getElementById("choose-card-to-play");
                    to_display_b.style="";
                    document.getElementsByClassName("counter")[0].innerHTML="";                    
                }

            });

            function cardToPlayChosen() {
                if(counter) {
                    document.getElementById("message-server").innerHTML = "Tu ne vas pas donner 2 cartes !";
                } else {
                    if(document.getElementsByClassName("carte-choisie").length==0){
                        document.getElementById("message-server").innerHTML = "N'oublie pas de s√©lectionner une carte d'abord !";
                    } else {
                        let carte = document.getElementsByClassName("carte-choisie")[0];
                        let src = carte.src;
                        socket.emit('guesser_card_to_play', src);
                    }
                }
            }

            socket.on('card_received', function() {
                document.getElementById("inst-with-keyphrase").innerHTML="Bien not√© ! Attendons les autres joueurs..."
                let to_hide = document.getElementById("choose-card-to-play");
                to_hide.style="display:none";
            });

            socket.on('start_guessing', function(nbJoueurs, cartes){
                populatePlateau(nbJoueurs, cartes);
            });

            

            function sendVote() {
                if(counter) {
                    display_short_message("Tu ne peux pas voter, petit tricheur !");
                } else {
                    if(document.getElementsByClassName("carte-choisie").length==0){
                        display_short_message("N'oublie pas de s√©lectionner une carte d'abord !");
                    } else {
                        let carte = document.getElementsByClassName("carte-choisie-d")[0];
                        let src = carte.src;
                        socket.emit('guesser_choice', pseudo, src);
                    }
                }
            }

            function cardSelected(id){
                if(document.getElementsByClassName("carte-choisie").length>0){
                    document.getElementsByClassName("carte-choisie")[0].classList.remove("carte-choisie");
                }
                document.getElementById(id).classList.add("carte-choisie");
            }

            function cardSelectedD(id){
                if(document.getElementsByClassName("carte-choisie-d").length>0){
                    document.getElementsByClassName("carte-choisie-d")[0].classList.remove("carte-choisie-d");
                }
                document.getElementById(id).classList.add("carte-choisie-d");
            }


            function populatePlateau(nbJoueurs, cartes){
                // 3 cartes par ligne
                nbLignes = Math.ceil(nbJoueurs/3);
                tableau = document.getElementById("plateau");
                for(let i = 0 ; i < nbLignes ; i++){
                    ligne = document.createElement("tr");
                    for(let j = 0 ; j < 3 ; j++){
                        if(3*i+j == nbJoueurs){
                            break;
                        }
                        let carte = document.createElement("img");
                        carte.src = cartes[3*i+j];
                        carte.classList.add("carte")
                        carte.id = "carte"+i+"-"+j;
                        carte.setAttribute('onClick', "cardSelectedD(this.id)");
                        let td = document.createElement("td");
                        td.appendChild(carte);
                        ligne.appendChild(td);
                    }
                    tableau.appendChild(ligne);
                }
            }

            function display_short_message(message) {
                document.getElementById("message-server").innerHTML = message;
                setTimeout(function() {
                    document.getElementById("message-server").innerHTML = ''; 
                }, 1000);
            }
        </script>
    </body>
</html>