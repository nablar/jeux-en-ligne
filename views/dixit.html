<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Dixit</title>
    </head>
 
    <body>
        <style>
            div.vue{
                display:none;
            }
            div.current-view{
                display:block;
            }
            div.chef{
                display:none;
            }
            div.current-chef{
                display:block;
            }
            th{
                width:30%;
                height: 50%;
            }
            img.carte{                        
                width:90%;
                height:auto;
                border: 5px hidden green;
            }
            img.carte-choisie{
                border:5px solid green;
                border-radius: 20px;
                box-shadow: 0px 0px 25px 5px green;
            }
        </style>

        <div id="message-server"></div>

        <!-- VUE A : choix du pseudo -->
        <div id="vue-A" class="current-view vue">
            <h1>Bienvenue sur le jeu Dixit !</h1>

            <p>Choisis ton pseudo</p>
            <p>
                <label for="pseudo">Pseudo</label>
                <input type="text" id="pseudo-input" name="pseudo" placeholder="Pseudo">
                <input type="submit" value="Valider" onclick="sendPseudo()"/>
            </p> 
        </div>



        <!-- VUE B : salle d'attente -->
        <div id="vue-B" class="vue">
            <h1>Vive le Dixit !</h1>
            <p>Attendons que tout le monde soit prêt...</p>
            
            <div id="pseudo"></div>
            <div class="chef">Tu es le chef du groupe, c'est à toi de décider quand commencer (attends que tout le monde soit là...)</div>
            </br>

            <div id="players"> En ligne : 
                <ul id="ul-list"> </ul>
            </div>

            <div class="chef">
                <input type="submit" value="Commencer" onclick="socket.emit('start_game');"/>
            </div>
        </div>



        <!-- VUE C : voir ses cartes -->
        <div id="vue-C" class="vue">
            <div class="counter"></div>

            <h1 id="inst-with-keyphrase" class="hide-if-counter" style="display:none">Choisis ta carte qui se rapporte le mieux à : "<span class="phrase-clef"></span>" ?</h1>

            <div id="phrase-clef-input" class="hide-if-not-counter">
                <label for="phrase-clef">Phrase clef</label>
                <input type="text" name="phrase-clef" placeholder="phrase-clef">
                <input type="submit" value="Valider" onclick="sendKeyPhrase()"/>
            </div>

            <input id="choose-card-to-play" style="display:none" class="hide-if-counter" type="submit" value="Valider" onclick="cardToPlayChosen()"/>

            <div class="cards-container">
                <table>
                    <tbody>
                        <tr>
                            <th><img id="carte0" class="carte" onclick="cardSelected(this.id)"></th>
                            <th><img id="carte1" class="carte" onclick="cardSelected(this.id)"></th>
                            <th><img id="carte2" class="carte" onclick="cardSelected(this.id)"></th>
                        </tr>
                        <tr>
                            <th><img id="carte3" class="carte" onclick="cardSelected(this.id)"></th>
                            <th><img id="carte4" class="carte" onclick="cardSelected(this.id)"></th>
                            <th><img id="carte5" class="carte" onclick="cardSelected(this.id)"></th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>



        <!-- VUE D : voir les cartes sur le plateau -->
        <div id="vue-D" class="vue">
            <div class="vote-except-counter">
                <h1>Selon toi, quelle carte correspond à "<span class="phrase-clef"></span>" ?</h1>
                <input type="submit" value="Voter" onclick="sendVote()"/>
            </div>

            <div class="cards-container">
                <table>
                    <tbody id="plateau">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VUE E : scores -->
        <div id="vue-E" class="vue">
            <h1>Voici les scores</h1>
            
            <div class="scores">
                
            </div>
        </div>

        



        <script src="/socket.io/socket.io.js"></script>
        <script>
            let socket = io.connect('http://localhost:50000');
            console.log(socket);
            let pseudo;
            let counter=false;

            function sendPseudo() {
                pseudo = document.getElementById("pseudo-input").value;
                socket.emit('pseudo', pseudo);
                document.getElementById("pseudo").innerHTML = "Hello " + pseudo;
                console.log("send the pseudo");
            }


            socket.on('change_view', function(view) {
                document.getElementById("message-server").innerHTML = "";
                document.getElementsByClassName("current-view")[0].classList.remove("current-view");
                document.getElementById("vue-"+view).classList.add("current-view");
                if(view==='C'){
                    socket.emit('tirage');
                }

            })

            // Liste des joueurs
            socket.on('players_list', function(list) {
                let ul = document.getElementById("ul-list");
                
                while (ul.hasChildNodes()) {  
                    ul.removeChild(ul.firstChild);
                }

                for (let i=0; i<list.length ; i++) {
                    var li = document.createElement("li");
                    li.appendChild(document.createTextNode(list[i]));
                    ul.appendChild(li);
                }
            });
            /*
            socket.on('leader', function() {
                for(let i=0; i<document.getElementsByClassName("chef").length; i++) {
                    document.getElementsByClassName("chef")[i].classList.add("current-chef");
                }
            }); */

            socket.on('new_leader', function(pseudo_chef) {
                if(pseudo_chef==pseudo) {
                    socket.emit('log-message', "Je suis le nouveau chef : " + pseudo);
                    for(let i=0; i<document.getElementsByClassName("chef").length; i++) {
                        document.getElementsByClassName("chef")[i].classList.add("current-chef");
                    }
                } else {
                    for(let i=0; i<document.getElementsByClassName("chef").length; i++) {
                        document.getElementsByClassName("chef")[i].classList.remove("current-chef");
                    }
                }
            });

            // Message d'erreur
            socket.on('message', function(message) {
                document.getElementById("message-server").innerHTML = message;
                /*setTimeout(function() {
                    document.getElementById("message-server").innerHTML = ''; 
                }, 1000);*/
                
            })

            socket.on('tirage', function(cartes){
                for (var i = 0; i < cartes.length; i++) {
                    document.getElementById("carte"+i).src = cartes[i];
                }
            });

            socket.on('counter', function(pseudo_counter) {
                let c = document.getElementsByClassName("counter")[0];
                if(pseudo==pseudo_counter) {
                    counter=true;
                    c.innerHTML = "Tu es le conteur, choisis une carte et ta phrase."
                    
                    for(let i=0; i<document.getElementsByClassName("hide-if-counter").length; i++) {
                        let to_remove = document.getElementsByClassName("hide-if-counter")[i];
                        to_remove.parentNode.removeChild(to_remove);
                    }
                } else {
                    for(let i=0; i<document.getElementsByClassName("hide-if-not-counter").length; i++) {
                        let to_remove = document.getElementsByClassName("hide-if-not-counter")[i];
                        to_remove.parentNode.removeChild(to_remove);
                    }
                    
                    counter=false;
                    c.innerHTML = "Le conteur est : " + pseudo_counter + ". Attends qu'il ait choisi sa carte."
                }
            });

            


            function sendKeyPhrase(){
                if(document.getElementsByClassName("carte-choisie").length==0){
                    document.getElementById("message-server").innerHTML = "N'oublie pas de sélectionner une carte d'abord !";
                } else {
                    let carte = document.getElementsByClassName("carte-choisie")[0];
                    let src = carte.src;
                    key_phrase = document.getElementById("phrase-clef-input").value;
                    socket.emit('counter_choice', src, key_phrase);
                }
            }

            socket.on('reveal_counter_choice', function(card, key_phrase) {
                for(let i=0; i<document.getElementsByClassName("phrase-clef").length; i++) {
                    document.getElementsByClassName("phrase-clef")[i].innerHTML = key_phrase;
                }
                if(counter) {
                    let to_remove = document.getElementById("phrase-clef-input");
                    to_remove.parentNode.removeChild(to_remove);
                    document.getElementsByClassName("counter")[0].innerHTML="Tes camarades sont en train de choisir leurs cartes.";
                } else {
                    let to_display = document.getElementById("inst-with-keyphrase");
                    to_display.style="";
                    let to_display_b = document.getElementById("choose-card-to-play");
                    to_display_b.style="";
                    document.getElementsByClassName("counter")[0].innerHTML="";                    
                }

            });

            function cardToPlayChosen() {
                if(counter) {
                    document.getElementById("message-server").innerHTML = "Tu ne vas pas donner 2 cartes !";
                } else {
                    if(document.getElementsByClassName("carte-choisie").length==0){
                        document.getElementById("message-server").innerHTML = "N'oublie pas de sélectionner une carte d'abord !";
                    } else {
                        let carte = document.getElementsByClassName("carte-choisie")[0];
                        let src = carte.src;
                        socket.emit('guesser_card_to_play', src);
                    }
                }
            }

            socket.on('start_guessing', function(nbJoueurs, cartes){
                populatePlateau(nbJoueurs, cartes);
            });

            

            function sendVote() {
                if(counter) {
                    display_short_message("Tu ne peux pas voter, petit tricheur !");
                } else {
                    if(document.getElementsByClassName("carte-choisie").length==0){
                        display_short_message("N'oublie pas de sélectionner une carte d'abord !");
                    } else {
                        let carte = document.getElementsByClassName("carte-choisie-d")[0];
                        let src = carte.src;
                        socket.emit('guesser_choice', pseudo, src);
                    }
                }
            }

            function cardSelected(id){
                if(document.getElementsByClassName("carte-choisie").length>0){
                    document.getElementsByClassName("carte-choisie")[0].classList.remove("carte-choisie");
                }
                document.getElementById(id).classList.add("carte-choisie");
            }

            function populatePlateau(nbJoueurs, cartes){
                // 3 cartes par ligne
                nbLignes = Math.floor(nbJoueurs/3);
                if(nbJoueurs%3 != 0){
                    nbLignes += 1;
                }
                tableau = document.getElementById("plateau");
                for(let i = 0 ; i < nbLignes ; i++){
                    ligne = document.createElement("tr");
                    for(let j = 0 ; j < 3 ; j++){
                        if(3*i+j == nbJoueurs){
                            break;
                        }
                        carte = document.createElement("img");
                        carte.src = cartes[3*i+j];
                        carte.classList.add("carte")
                        carte.id = "carte"+i+"-"+j;
                        carte.onclick = "cardSelected(this.id)";
                        ligne.appendChild(carte);
                    }
                    tableau.appendChild(ligne);
                }
            }

            function display_short_message(message) {
                document.getElementById("message-server").innerHTML = message;
                setTimeout(function() {
                    document.getElementById("message-server").innerHTML = ''; 
                }, 1000);
            }
        </script>
    </body>
</html>